# Template file for 'qubes-gui-agent-linux'
pkgname=qubes-gui-agent-linux
version=4.0.10
revision=3
#wrksrc=
#create_wrksrc=yes
#only_for_archs="i686 x86_64"
build_style=gnu-makefile
#configure_args=""

#this doesn't work!
#make_build_args=""
#make_install_args=""

#conf_files=""
#make_dirs=""
hostmakedepends="pkg-config"
makedepends="patch automake autoconf libltdl-devel
 pulseaudio-devel xorg-server-devel xorg-util-macros libXcomposite-devel
 qubes-gui-common-devel qubes-core-vchan-xen-devel qubes-core-qubesdb libXt libtool"

depends="xinit libXcomposite zenity qubes-core-vchan-xen xcb-proto xorg-server<1.20.0
 qubes-vmm-xen alsa-lib alsa-utils alsa-plugins-pulseaudio pulseaudio>=11.1
 pulseaudio<11.2 elogind xcffib linux4.16-headers-4.16.7_1 linux4.16-4.16.7_1"

short_desc="The Qubes GUI Agent for AppVMs xcffib"
maintainer="nexolight <snow.dream.ch@gmail.com>"
license="GPL"
homepage="http://qubes-os.org"
distfiles="https://github.com/QubesOS/${pkgname}/archive/v${version}.tar.gz"
checksum="035701f41cf207a06e02408be0dcedd6692eae4b8dc959b3fdb4687d45940313"

do_configure(){
	echo "Skip configure"
}

do_build(){
	#Force running all scripts with python2
	sed 's:#!/usr/bin/python:#!/usr/bin/python2:' -i appvm-scripts/usrbin/*
	sed 's:#!/usr/bin/env python:#!/usr/bin/env python2:' -i appvm-scripts/usrbin/*
	sed 's:#!/usr/bin/python:#!/usr/bin/python2:' -i window-icon-updater/*
	sed 's:#!/usr/bin/env python:#!/usr/bin/env python2:' -i window-icon-updater/*

	env="BACKEND_VMM=xen"
	(export ${env}; make -j ${makejobs} appvm)
}

do_install(){

	env="DESTDIR=${DESTDIR} LIBDIR=/usr/lib USRLIBDIR=/usr/lib SYSLIBDIR=/usr/lib BACKEND_VMM=xen"
	#(export ${env}; make install-rh-agent)
	#(export ${env}; make install-pulseaudio)

	(export ${env}; 
		make install-common; 
		make install-rh-agent;
		make install-pulseaudio;
		make install-xfce;
	)
	rm -f ${DESTDIR}/etc/init.d/*
	
	#replace service with a runit one
	rm -rf ${DESTDIR}/usr/lib/systemd
	
	#the qubes-gui agent does start an X server
	#which will not terminate when the qubes-gui is terminated
	#after that it doesn't work anymore until the X server is killed.
	#due to limitations of runit it will kill the Xorg instance before start

	vsv qubes-gui-agent

	#Alternative approach via rc.local
	#vmkdir /etc/rc.local-qubes/qubes-gui-agent
	#vinstall ${FILESDIR}/rc.local 755 /etc/rc.local-qubes/qubes-gui-agent

	#setup qubes session
	vinstall ${FILESDIR}/z-qubes-session.sh 755 /etc/X11/xinit/xinitrc.d
	
}
