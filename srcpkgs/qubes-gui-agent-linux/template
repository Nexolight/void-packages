# Template file for 'qubes-gui-agent-linux'
pkgname=qubes-gui-agent-linux
version=4.0.18
revision=1
build_style=gnu-makefile
hostmakedepends="pkg-config"
makedepends="patch automake autoconf libltdl-devel
 pulseaudio-devel xorg-server-devel xorg-util-macros libXcomposite-devel
 qubes-gui-common-devel qubes-core-vchan-xen-devel qubes-core-qubesdb libXt libtool git"
depends="xinit libXcomposite zenity qubes-core-vchan-xen xcb-proto xorg-server
 qubes-vmm-xen alsa-lib alsa-utils alsa-plugins-pulseaudio pulseaudio elogind xcffib"
short_desc="The Qubes GUI Agent for AppVMs xcffib"
maintainer="nexolight <snow.dream.ch@gmail.com>"
license="GPL"
homepage="http://qubes-os.org"
distfiles="https://github.com/QubesOS/${pkgname}/archive/v${version}.tar.gz"
checksum="7e0434834b2ae114de9de2e448d87700f1d9bac046d1f44582c99684b4d195c0"

do_configure(){
	echo "Skip configure"
}

do_build(){
	#Force running all scripts with python2
	sed 's:#!/usr/bin/python:#!/usr/bin/python2:' -i appvm-scripts/usrbin/*
	sed 's:#!/usr/bin/env python:#!/usr/bin/env python2:' -i appvm-scripts/usrbin/*
	sed 's:#!/usr/bin/python:#!/usr/bin/python2:' -i window-icon-updater/*
	sed 's:#!/usr/bin/env python:#!/usr/bin/env python2:' -i window-icon-updater/*


	#Fix the build on our rolling release distro if the repository is behind.
	PA_VER=$(pkg-config --modversion libpulse | cut -d "-" -f 1 || echo 0.0)
	if [ ! -d "pulse/pulsecore-$PA_VER" ];then
		rm -rf "pulsetmp"
		mkdir -p "pulsetmp"
		git clone --branch "v$PA_VER" https://github.com/pulseaudio/pulseaudio.git "pulsetmp"
		mv pulsetmp/src/pulsecore "pulse/pulsecore-$PA_VER"
	fi

	env="BACKEND_VMM=xen"
	(export ${env}; make -j ${makejobs} appvm)
}

do_install(){

	env="DESTDIR=${DESTDIR} LIBDIR=/usr/lib USRLIBDIR=/usr/lib SYSLIBDIR=/usr/lib BACKEND_VMM=xen"
	#(export ${env}; make install-rh-agent)
	#(export ${env}; make install-pulseaudio)

	(export ${env}; 
		make install-common; 
		make install-rh-agent;
		make install-pulseaudio;
		make install-xfce;
	)
	rm -f ${DESTDIR}/etc/init.d/*
	
	#replace service with a runit one
	rm -rf ${DESTDIR}/usr/lib/systemd
	
	#the qubes-gui agent does start an X server
	#which will not terminate when the qubes-gui is terminated
	#after that it doesn't work anymore until the X server is killed.
	#due to limitations of runit it will kill the Xorg instance before start

	vsv qubes-gui-agent

	#Alternative approach via rc.local
	#vmkdir /etc/rc.local-qubes/qubes-gui-agent
	#vinstall ${FILESDIR}/rc.local 755 /etc/rc.local-qubes/qubes-gui-agent

	#setup qubes session
	vinstall ${FILESDIR}/z-qubes-session.sh 755 /etc/X11/xinit/xinitrc.d
	
}
