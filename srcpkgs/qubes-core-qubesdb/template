# Template file for 'qubes-core-qubesdb'
pkgname=qubes-core-qubesdb
version=4.0.10
revision=1
build_style=gnu-makefile

hostmakedepends=""
makedepends="qubes-core-vchan-xen-devel python-devel python3-devel pkg-config"
depends="qubes-core-vchan-xen"
short_desc="QubesDB libs and daemon service"
maintainer="nexolight <snow.dream.ch@gmail.com>"
license="GPL"
homepage="http://qubes-os.org"
shlib_provides="libqubesdb.so"
distfiles="https://github.com/QubesOS/${pkgname}/archive/v${version}.tar.gz"
checksum="deb3851f8760fe2fe2e4965b4100bfa965a240583e39a36e4a65fcc2a2f4d724"

do_configure(){
	echo "Skip configure"
}

do_build(){
	#sorry for the sledgehammer method but the author mentions it is not a requirement
	#when NOTIFY_SOCKET is disabled. Ther's no way to build without this.
	sed -i 's/^LIBS.*systemd.*$//g' daemon/Makefile
	sed -i 's/^CFLAGS.*systemd.*$//g' daemon/Makefile
	sed -i 's/^#include.*systemd.*$//g' daemon/db-daemon.c
	sed -i 's/sd_notify.*$//g' daemon/db-daemon.c

	env="NOTIFY_SOCKET=false PYTHON=python2 BACKEND_VMM=xen C_INCLUDE_PATH=/usr/include/vchan-xen:${C_INCLUDE_PATH}"
	(export ${env}; make -j ${makejobs} all)
	#python3 bindings
	make -j ${makejobs} -C python
}

do_install(){
	vmkdir /usr/lib64
	vmkdir /usr/lib
	env="DESTDIR=${DESTDIR} LIBDIR=/usr/lib SYSLIBDIR=/usr/lib SBINDIR=/usr/bin"
	(export ${env} PYTHON=python2; make install)
	(export ${env}; cd python; make install)
	cp ${DESTDIR}/usr/lib64/* ${DESTDIR}/usr/lib/
	rm -rf ${DESTDIR}/usr/lib64
	
	vinstall ${FILESDIR}/98-40-qubesdb.sh 644 /etc/runit/core-services
}
