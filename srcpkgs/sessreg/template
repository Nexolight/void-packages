# Template build file for 'sessreg'.
pkgname=sessreg
version=1.1.0
revision=4
build_style=gnu-configure
hostmakedepends="pkg-config"
makedepends="libX11-devel"
short_desc="Manage utmp/wtmp entries for xdm"
homepage="http://xorg.freedesktop.org"
license="MIT"
maintainer="Juan RP <xtraeme@voidlinux.eu>"
distfiles="${XORG_SITE}/app/$pkgname-$version.tar.bz2"
checksum=551177657835e0902b5eee7b19713035beaa1581bbd3c6506baa553e751e017c

case "$XBPS_TARGET_MACHINE" in
	*-musl)
		# musl does not define _WTMPX_FILE, use WTMP_FILE instead.
		CFLAGS="-D_WTMPX_FILE=WTMP_FILE -D_PATH_WTMPX=_PATH_WTMP"
		# musl does not define _UTMPX_FILE, use UTMP_FILE instead.
		CFLAGS+=" -D_UTMPX_FILE=UTMP_FILE -D_PATH_UTMPX=_PATH_UTMP"
		;;
esac

post_configure() {
	local _gccver=$(gcc --version | awk '/^gcc \(GCC\)/ { print $3 }')
	#
	# gcc6 cpp fails to generate filenames.sed from filenames.sed.c
	# thus we remove the buuld rule and provide a filenames.sed file
	# with the expected output for Void Linux.
	#
	if [ "${_gccver%%.*}" -gt 5 ]; then
		sed -i man/Makefile -e'/filenames.sed: filenames.sed.c/,+4d'
		cat > man/filenames.sed << EOF
/__BEGIN_UTMP_ONLY__/,/__END_UTMP_ONLY__/ d
s|__utmp_manpage__|utmpx|g
s|__utmp_file__|"/var/run/utmp"|g
s|__wtmp_manpage__|wtmpx|g
s|__wtmp_file__|"/var/log/wtmp"|g
s|__ttys_file__|"/etc/ttys"|g
s|__lastlog_file__|"/var/log/lastlog"|g
EOF
	fi
}

post_install() {
	vlicense COPYING
}
