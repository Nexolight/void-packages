# Template file for 'qubes-core-agent-linux'
pkgname=qubes-core-agent-linux
version=4.0.38
revision=1
build_style=gnu-makefile
make_build_args="PKG_CONFIG_PATH=/usr/lib/pkgconfig BACKEND_VMM=xen C_INCLUDE_PATH=/usr/include/vchan-xen:${C_INCLUDE_PATH}"
hostmakedepends=""
makedepends="qubes-core-vchan-xen-devel qubes-linux-utils qubes-vmm-xen libX11-devel python python3 pam-devel pkg-config python-setuptools python-pip pandoc"
depends="qubes-core-vchan-xen qubes-core-qubesdb python pandoc python-xdg ethtool ntp net-tools ImageMagick fakeroot notification-daemon dconf zenity haveged python-gobject python-dbus xdg-utils gawk sed procps-ng librsvg socat gnome-keyring gnome-settings-daemon python python-setuptools iptables NetworkManager"
short_desc="The qubes qrexec agent"
maintainer="nexolight <snow.dream.ch@gmail.com>"
license="GPL"
homepage="http://qubes-os.org/"
shlib_provides=""
distfiles="https://github.com/QubesOS/${pkgname}/archive/v${version}.tar.gz"
checksum="90f404a72ec1f8e9ff0842f0fc0b059d85b09dfa259fa1d837a5f0b4c2944b23"
system_groups="qubes:98 user:1100"
system_accounts="user:1100"
user_homedir="/home/user"
user_shell="/bin/bash"
user_descr="qubes user"
user_groups="qubes,root"
user_pgroup="user"

do_configure(){
	echo "Skip configure"
}

do_build(){
	(cd misc; make -j ${makejobs} ${make_build_args})
	(cd qrexec; make -j ${makejobs} ${make_build_args})
	(cd qubes-rpc; make -j ${makejobs} ${make_build_args})
}

do_install(){
	#using make_install_args does not work
	env="PYTHON=python2 SBINDIR=/usr/bin LIBDIR=/usr/lib SYSLIBDIR=/usr/lib DESTDIR=${DESTDIR}"
	(export ${env}; make -C qrexec install)
	(export ${env}; make install-corevm)
	(export ${env}; pip install python-daemon)
	(export ${env}; make install-netvm)

	#remove unused files
	rm -rf ${DESTDIR}/usr/lib/systemd*
	rm -rf ${DESTDIR}/lib/systemd*
	rm -rf ${DESTDIR}/etc/systemd*
	rm -rf ${DESTDIR}/etc/yum*
	rm -rf ${DESTDIR}/etc/dnf*
	rm -rf ${DESTDIR}/etc/init.d
	rm -rf ${DESTDIR}/etc/fstab
	rm -rf ${DESTDIR}/etc/sysctl.d

	#Service helper scripts
	
	#setup services
	#NOTE: Since most of it are oneshot processes and rely on services in a mixed manner
	#TODO: I'm not entirely convinced that this works as it should at stage 1.
	vinstall ${FILESDIR}/98-50-qubes-client-vm.sh 644 /etc/runit/core-services

	#Some stuff doesn't seem to work at stage 1.
	#Since some of them are no real services let's put them in rc.local at stage 3
	vinstall ${FILESDIR}/rc.local 755 /etc/rc.local-qubes/${pkgname}
}

